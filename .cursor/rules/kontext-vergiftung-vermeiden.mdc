---
description: Kontext-Vergiftung vermeiden ‚Äì wenn Schutzregeln zu Sperren werden
alwaysApply: true
---

# üîí KONTEXT-VERGIFTUNG ‚Äì gr√∂√üerer Zusammenhang beim Absichern

## Was passiert ist (Lehre aus 22.02.26)

Wir haben die K2 vs. √∂k2 Datentrennung sehr streng abgesichert:
- √∂k2 darf keine K2-Daten sehen
- K2-Pfade (`data:`, `/img/k2/`) werden im √∂k2-Kontext gel√∂scht
- Kontext wird in sessionStorage gespeichert

**Das Problem:** sessionStorage ist browser-session-weit. Nach √∂k2-Admin-Besuch blieb `k2-admin-context = 'oeffentlich'` erhalten. Beim n√§chsten K2-Admin-Aufruf **ohne** `?context=` Parameter: Code dachte er ist im √∂k2-Kontext ‚Üí K2-Fotos wurden in √∂k2-Keys gespeichert ‚Üí K2-Galerie sah nie die neuen Bilder.

**Kurzform:** Eine Schutzregel hat sich selbst gegen den Benutzer gewendet.

## Die √ºbergeordnete Regel

**Beim Absichern immer den gr√∂√üeren Zusammenhang fragen:**

> ‚ÄûWas passiert wenn jemand zwischen den Kontexten wechselt?"
> ‚ÄûWas passiert wenn der Schutz sich im falschen Moment aktiviert?"
> ‚ÄûKann diese Regel den normalen Betrieb blockieren?"

## Konkrete Checkliste bei JEDER neuen Schutz-/Trennungsregel

- [ ] **Kontext-Persistenz:** Wo wird der Kontext gespeichert? localStorage / sessionStorage / URL? Was passiert beim Wechsel?
- [ ] **Reset-Pfad:** Gibt es immer einen klaren Weg zur√ºck in den Normalzustand? (z.B. `sessionStorage.removeItem` beim normalen Aufruf)
- [ ] **Stille Fehler:** Wird bei Regelversto√ü etwas gel√∂scht/ignoriert ohne Meldung? Dann ist das schwer zu debuggen.
- [ ] **Beide Richtungen testen:** Nicht nur "√∂k2 darf keine K2-Daten sehen" ‚Äì auch "K2 funktioniert noch nachdem √∂k2 besucht wurde"
- [ ] **Fallback sichtbar machen:** Wenn eine Schutzregel greift (z.B. Bild wird gel√∂scht), zumindest in der Konsole loggen warum

## Muster das immer wieder auftaucht

```
Schutzregel A: "X darf nicht in Kontext Y"
Vergessene Frage: "Was passiert wenn man von Y zur√ºck nach X wechselt?"
Ergebnis: X funktioniert nicht mehr, Ursache v√∂llig unklar
```

## Kurzfassung

**Beim Absichern nicht nur "was darf nicht passieren" denken ‚Äì auch "was muss danach noch funktionieren" und "wie kommt man wieder heraus".**

Georgs Instinkt: "Das habt ihr so versperrt dass ihr selbst nicht mehr reinkommt" = die wichtigste Frage bei jeder Schutzregel.
