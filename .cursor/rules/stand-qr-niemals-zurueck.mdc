---
description: Stand/QR ‚Äì NIEMALS abschw√§chen. Sonst steht Georg wieder vor altem Stand auf dem Handy (Stunden Frust).
alwaysApply: true
---

# üîí STAND & QR ‚Äì NIEMALS ZUR√úCK (kritisch f√ºr Georg)

## Warum diese Regel

- Georg hat **dutzende Male** das Problem gehabt: Handy zeigt alte Version (z.B. 15:22), obwohl auf Vercel neu (15:46). Dann funktioniert es, ein paar Sessions sp√§ter wieder derselbe Fehler ‚Üí **Stunden umsonst**.
- Diese Regel stellt sicher, dass **keine** √Ñnderung die Fixes wieder r√ºckg√§ngig macht. Jede Session (AI/Entwickler) muss sie einhalten.

## Unver√§nderliche Anforderungen

### 1. QR-Code = immer Server-Stand + Cache-Bust

- **NIEMALS** nur `urlWithBuildVersion(url)` mit lokalem `BUILD_TIMESTAMP` f√ºr QR verwenden. Das f√ºhrt dazu, dass der QR die **lokale** Build-Zeit enth√§lt; wenn der Mac einen alten Build hat oder Cache im Spiel ist, bekommt das Handy die alte Version.
- **IMMER** f√ºr alle QR-Codes, die auf die **Vercel-Galerie** zeigen:
  - **Server-Stand** verwenden: z.B. `useServerBuildTimestamp()` / `useQrVersionTimestamp()` aus `src/hooks/useServerBuildTimestamp.ts`.
  - **Cache-Bust pro Anzeige:** `buildQrUrlWithBust(url, versionTs)` ‚Äì h√§ngt `v=<timestamp>&_=<Date.now()>` an. Jeder Scan = neue URL = kein CDN-Cache.
- **Betroffene Dateien:** `GaleriePage.tsx`, `PlatformStartPage.tsx`, `MobileConnectPage.tsx`. Dort **darf** f√ºr Vercel-/Galerie-URLs **nur** `buildQrUrlWithBust(..., useQrVersionTimestamp())` (bzw. Hook + Bust) verwendet werden, **nicht** `urlWithBuildVersion(...)`.

### 2. Build: inject-Script in index.html ‚Äì ‚ÄûSeite √∂ffnen = Update‚Äú

- **Ohne dieses Script bekommen Mobilger√§te beim Seitenneustart kein Update** (Georg hat das mehrfach erlebt). Es ist genauso kritisch wie QR/Stand.
- `scripts/write-build-info.js` muss mit `--inject-html` aufgerufen werden (z.B. im npm build). Das Script:
  - Pr√ºft, ob das geladene HTML √§lter als 2 Minuten ist ‚Üí einmal Reload mit Cache-Bust.
  - Holt `build-info.json`; wenn Server neuer ‚Üí Reload mit frischer URL.
  - Bei Fetch-Fehler (fremdes WLAN etc.): einmal Reload mit Cache-Bust (mit sessionStorage gegen Schleifen).
- **NIEMALS** das Inject-Script entfernen oder so vereinfachen, dass diese drei Verhaltensweisen wegfallen.
- **JEDER Build muss das Inject-Script mit AKTUELLEM Timestamp ausliefern.** Daf√ºr:
  - **Option A:** In `index.html` steht der Placeholder `<!-- BUILD_TS_INJECT -->` ‚Üí Build ersetzt ihn durch das Script (mit aktuellem `b=<timestamp>`).
  - **Option B (Fallback):** Steht schon ein altes Script drin (z.B. `var b=123456;`), muss write-build-info.js das **gesamte** alte Script per Regex ersetzen durch das neue mit aktuellem Timestamp. **Diesen Fallback NIEMALS entfernen** ‚Äì sonst wird nach dem ersten Inject nie wieder aktualisiert und ‚ÄûSeite √∂ffnen = Update‚Äú ist sofort wieder kaputt.
- **Placeholder:** Ideal ist, dass `index.html` im Repo den Placeholder enth√§lt; wenn nicht, muss Option B (Regex-Ersetzung des alten Scripts) greifen.

### 3. Vercel: no-cache f√ºr HTML und build-info

- `vercel.json`: F√ºr `/`, `/index.html`, `/build-info.json`, `/projects/:path*` **muss** `Cache-Control: no-cache, no-store, must-revalidate, max-age=0` gesetzt sein.
- **NIEMALS** diese Header entfernen oder abschw√§chen (z.B. max-age > 0 f√ºr index.html).
- `build-info.json` muss von Rewrites ausgenommen sein (erreichbar unter `/build-info.json`).

### 4. Server-Stand f√ºr QR

- `src/hooks/useServerBuildTimestamp.ts`: Enth√§lt `useServerBuildTimestamp`, `buildQrUrlWithBust`, `useQrVersionTimestamp`. **Nicht entfernen oder umbenennen**, sodass die Seiten wieder auf rein lokalen Build umstellen k√∂nnten.
- Die Produktions-URL f√ºr build-info ist `https://k2-galerie.vercel.app/build-info.json`. Beim √ñffnen der APf wird diese URL abgefragt; der QR verwendet dann den **Server-**Timestamp.

## Checkliste vor √Ñnderungen (wenn einer dieser Bereiche betroffen ist)

- Build-Skripte (package.json, write-build-info.js)
- index.html (Placeholder, Scripte)
- vercel.json (Headers, Rewrites)
- QR-Code-Generierung (GaleriePage, PlatformStartPage, MobileConnectPage)
- Hooks/Utils f√ºr Stand (useServerBuildTimestamp, buildInfo.generated)

**Dann pr√ºfen:**

- [ ] QR f√ºr Vercel-Galerie nutzt weiterhin Server-Timestamp + `buildQrUrlWithBust` (kein reines `urlWithBuildVersion`).
- [ ] Build ruft weiterhin `write-build-info.js --inject-html` auf; Inject-Script bleibt vollst√§ndig (Stale-Check, build-info-Fetch, Fehler-Reload).
- [ ] Inject bei jedem Build mit aktuellem Timestamp: Placeholder in index.html ODER Fallback in write-build-info.js (altes Script per Regex ersetzen) ‚Äì beides nicht entfernen.
- [ ] vercel.json beh√§lt no-cache f√ºr index.html und build-info.json.
- [ ] Hook `useServerBuildTimestamp` / `buildQrUrlWithBust` bleibt in Verwendung f√ºr alle relevanten QRs.

## Kurzfassung

- **QR:** Immer Server-Stand + `&_=Date.now()` (buildQrUrlWithBust + useQrVersionTimestamp). Nie nur lokaler BUILD_TIMESTAMP f√ºr QR.
- **HTML:** Inject-Script bleibt (Stale + build-info + Fehler-Reload). Jeder Build muss Script mit aktuellem Timestamp liefern (Placeholder oder Fallback-Regex in write-build-info.js).
- **Vercel:** no-cache f√ºr index.html und build-info.json bleibt.
- **Nicht:** Diese Logik ‚Äûvereinfachen‚Äú, ‚Äûaufr√§umen‚Äú oder durch ‚Äûnur lokalen Stand‚Äú ersetzen ‚Äì sonst ist das Problem sofort wieder da.
