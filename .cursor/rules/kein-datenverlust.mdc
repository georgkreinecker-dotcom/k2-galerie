---
description: Kritische Benutzerdaten (Stammdaten, Kontakt) niemals verlieren. Repo = Quelle, Merge beim Laden/Speichern.
alwaysApply: true
---

# üîí Kein Datenverlust ‚Äì kritische Daten immer sichern

## ‚õî ABSOLUTES NO-GO (f√ºhrt zu Chaos)

**Gespeicherte Stammdaten (localStorage, k2-stammdaten-*) NIEMALS mit leeren Werten √ºberschreiben.**

- **Verboten:** Ein Feld, das im Speicher bereits einen Wert hat (z. B. welcomeImage, virtualTourImage, galerieCardImage, Kontakt, Adresse), durch `''` oder `undefined` zu ersetzen.
- **Pflicht:** Beim Zusammenf√ºhren (Merge), Reparieren oder Laden: **Bestehenden Wert aus dem Speicher √ºbernehmen**, wenn der neue Wert leer ist. Nur auff√ºllen, nie leeren.
- **Bilder:** welcomeImage, virtualTourImage, galerieCardImage sind besonders fehleranf√§llig (z. B. beim Laden von gallery-data.json ohne Base64). Immer: `neuerWert || bestehenderWertAusSpeicher || ''` ‚Äì nie nur `neuerWert || ''`.

Wer diese Regel bricht, l√∂scht Nutzerdaten und verursacht Chaos. Bei jeder √Ñnderung an Laden/Speichern/Merge von Stammdaten: Pr√ºfen, ob ein bestehender Wert durch Leer √ºberschrieben werden k√∂nnte ‚Äì wenn ja, zuerst aus Speicher lesen und erhalten.

## Regel (immer einhalten)

**Kritische Benutzerdaten d√ºrfen niemals verloren gehen.** Daf√ºr gelten:

1. **Quelle im Repo**
   - Stammdaten (Kontakt: E-Mail, Telefon, Namen, Galerie) haben eine **verbindliche Quelle im Code**: `src/config/tenantConfig.ts` ‚Üí `K2_STAMMDATEN_DEFAULTS`.
   - Diese Werte sind die Fallback-Standards. Sie m√ºssen vollst√§ndig und korrekt sein (z.‚ÄØB. echte @kgm.at-Adressen, echte Telefonnummern).

2. **Beim Laden / ‚ÄûReparieren‚Äú**
   - Wo immer Stammdaten aus localStorage geladen werden: **Leere Kontaktfelder** (email, phone, name, website) werden aus `K2_STAMMDATEN_DEFAULTS` gef√ºllt.
   - **Niemals** beim Reparieren das **gesamte** Objekt √ºberschreiben: Nur die Kontaktfelder (email, phone, name, website; bei Galerie zus√§tzlich address, city, country, openingHours) in den Speicher zur√ºckschreiben. **welcomeImage**, **virtualTourImage**, **galerieCardImage** und alle anderen Felder aus dem **bestehenden** gespeicherten Objekt √ºbernehmen (Spread: `{ ...existing, email: ..., phone: ... }`). **Niemals** ein Objekt bauen, in dem Bild- oder andere Nutzerfelder mit `''` stehen, ohne vorher den bestehenden Speicher zu lesen und diese Felder daraus zu √ºbernehmen. Sonst gehen Willkommensbild, Adresse und andere vom Nutzer gepflegte Daten verloren.

3. **Beim Speichern (Auto-Save, saveNow, manuell)**
   - **Niemals** vorhandene E-Mail/Telefon/Namen/Adresse mit **leeren** Werten √ºberschreiben.
   - Vor dem Schreiben: Wenn der eingehende Wert leer ist, **bestehenden** Wert aus localStorage behalten; wenn auch der bestehende leer ist, **Repo-Standard** (`K2_STAMMDATEN_DEFAULTS`) verwenden.
   - Umsetzung: siehe `src/utils/autoSave.ts` (mergeStammdatenPerson, mergeStammdatenGallery) und gleiche Logik √ºberall, wo Stammdaten geschrieben werden.

4. **Keine Ausrede ‚Äûnur localStorage‚Äú**
   - Sich auf ‚Äûdie Daten waren vermutlich nur im localStorage‚Äú zu berufen ist unzul√§ssig.
   - Aufgabe ist, **daf√ºr zu sorgen**, dass nichts verloren geht: Repo-Standard + Merge beim Laden/Speichern.

5. **Bei gemeldetem Datenverlust: ZUERST Backup nutzen**
   - Wir haben ein doppeltes Backup (Auto-Backup alle 5 Sek. in `k2-full-backup` + Vollbackup-Datei / backupmicro).
   - Wenn der Nutzer sagt, Daten (z.‚ÄØB. Stammdaten, E-Mail, Telefon) seien weg oder falsch:
     - **Zuerst:** Hinweis auf **‚ÄûAus letztem Backup wiederherstellen‚Äú** (Admin ‚Üí Einstellungen ‚Üí Backup & Wiederherstellung). Die Stammdaten sind im Vollbackup enthalten.
     - **Pr√ºfen:** Gibt es eine Vollbackup-Datei im Projekt (z.‚ÄØB. ‚ÄûK2 Backups‚Äú, exportierte JSON)? Wenn ja, daraus die Werte ermitteln und in `K2_STAMMDATEN_DEFAULTS` oder per Wiederherstellung zur√ºckf√ºhren.
   - Erst danach oder zus√§tzlich: Repo-Standard (K2_STAMMDATEN_DEFAULTS) sicherstellen und Merge-Logik beim Laden/Speichern.

## Betroffene Stellen

- `src/config/tenantConfig.ts`: `K2_STAMMDATEN_DEFAULTS` aktuell und vollst√§ndig halten.
- `src/utils/autoSave.ts`: Stammdaten-Merge beim Intervall und bei saveNow.
- `components/ScreenshotExportAdmin.tsx`: Stammdaten-Laden mit Auff√ºllen aus K2_STAMMDATEN_DEFAULTS; Speichern nur √ºber saveStammdaten (√∂k2 schreibt nicht in K2-Keys).
- `src/pages/GaleriePage.tsx`: Stammdaten-Laden mit Auff√ºllen aus K2_STAMMDATEN_DEFAULTS.

## Bei neuen Features

- Wenn neue **kritische Daten** (Kontakt, Adresse, √ñffnungszeiten, etc.) dazu kommen: zuerst in `K2_STAMMDATEN_DEFAULTS` abbilden, dann beim Laden/Speichern die gleiche ‚Äûnie leer √ºberschreiben / immer aus Repo auff√ºllen‚Äú-Logik anwenden.

## Checkliste bei √Ñnderungen an Stammdaten-Logik

Vor dem Abschluss pr√ºfen:

- [ ] Wird irgendwo ein Objekt f√ºr Galerie/Martina/Georg gebaut, in dem Felder (z. B. welcomeImage, virtualTourImage, galerieCardImage) auf `''` gesetzt werden? Wenn ja: vorher bestehenden Speicher lesen und diese Felder daraus √ºbernehmen.
- [ ] Beim Merge mit Server-Daten (z. B. gallery-data.json): Enth√§lt die Antwort oft keine Base64-Bilder? Wenn ja: Bilder aus localStorage √ºbernehmen, wenn Server-Wert leer ist.
- [ ] Wird `setGalleryData` / √§hnlicher State mit einem Objekt aufgerufen, das Nutzerfelder leer hat? Wenn ja: nur bef√ºllte Felder √ºberschreiben oder vorher bestehende Werte einspielen.
